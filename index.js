"use strict";
var Promise = require("bluebird");
var child_process_1 = require("child_process");
var fs_1 = require("fs");
function getPercentSpace(dir) {
    return new Promise(function (resolve, reject) {
        child_process_1.exec("df -h " + dir + " | grep '/'", function (err, stdout, stderr) {
            if (err) {
                reject(err);
            }
            else {
                var reout = [];
                for (var i = 0; i < stdout.split(" ").length; i++) {
                    if (stdout.split(" ")[i])
                        reout.push(stdout.split(" ")[i].replace('\n', ''));
                }
                resolve(reout[4].replace('%', ''));
            }
        });
    });
}
function removeLastFileFromDir(dir) {
    return new Promise(function (resolve, reject) {
        var fis = fs_1.readdirSync(dir);
        var files = [];
        for (var i = 0; i < fis.length; i++) {
            if (!fs_1.statSync(dir + "/" + fis[i]).isDirectory()) {
                files.push(fis[i]);
            }
        }
        if (files.length > 1) {
            files.sort(function (a, b) {
                return fs_1.statSync(dir + "/" + a).mtime.getTime() -
                    fs_1.statSync(dir + "/" + b).mtime.getTime();
            });
            child_process_1.exec("rm '" + dir + "/" + files[0] + "'", function (err, stdout, stderr) {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(true);
                }
            });
        }
        else {
            reject("nothing to remove!");
        }
    });
}
function remfiles(dir) {
    return new Promise(function (resolve, reject) {
        function recursiveremfiles(dir) {
            getPercentSpace(dir).then(function (percent) {
                if (percent > 10) {
                    removeLastFileFromDir(dir).then(function () {
                        recursiveremfiles(dir);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    resolve(true);
                }
            }).catch(function (err) {
                reject(err);
            });
        }
        recursiveremfiles(dir);
    });
}
function checkSpaceInDir(dir, options) {
    return new Promise(function (resolve, reject) {
        if (!dir) {
            if (options && options.verbose)
                console.error("No dir provided");
            reject("No dir provided");
        }
        else {
            if (options && options.verbose)
                console.log("checking disk");
            getPercentSpace(dir).then(function (percent) {
                if (percent > 10) {
                    remfiles(dir).then(function (a) {
                        if (options && options.verbose)
                            console.log("space cleaned");
                        resolve(a);
                    }).catch(function (err) {
                        if (options && options.verbose)
                            console.error(err);
                        reject(err);
                    });
                }
                else {
                    if (options && options.verbose)
                        console.log("disk checked");
                    resolve("disk ok, nothing to do");
                }
            }).catch(function (err) {
                reject(err);
            });
        }
    });
}
exports.checkSpaceInDir = checkSpaceInDir;
var recursivecheckSpaceInDir = (function () {
    function recursivecheckSpaceInDir(options) {
        if (!options) {
            throw Error("No dir provided");
        }
        else {
            this.dir = options.dir;
            if (!options.interval)
                options.interval = 5 * 60;
            this.interval = options.interval;
            if (!options.extension)
                this.extension = options.extension;
            this.verbose = false;
            if (options.verbose)
                this.verbose = options.verbose;
        }
    }
    recursivecheckSpaceInDir.prototype.run = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            checkSpaceInDir(that.dir, { extension: that.extension, verbose: that.verbose }).then(function (a) {
                if (that.verbose)
                    console.log("disk check ok");
                resolve(a);
            }).then(function (err) {
                if (that.verbose)
                    console.error(err);
                reject(err);
            });
        });
    };
    recursivecheckSpaceInDir.prototype.daemonize = function (interval) {
        if (interval)
            this.interval = interval;
        var that = this;
        that.run();
        setInterval(function () {
            that.run();
        }, this.interval);
    };
    return recursivecheckSpaceInDir;
}());
exports.recursivecheckSpaceInDir = recursivecheckSpaceInDir;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxrQ0FBbUM7QUFDbkMsK0NBQW9DO0FBQ3BDLHlCQUEwQztBQUUxQyx5QkFBeUIsR0FBVztJQUNoQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUUvQixvQkFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsYUFBYSxFQUFFLFVBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNO1lBQ3JELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2YsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVKLElBQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQTtnQkFDaEIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNoRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7Z0JBQ2hGLENBQUM7Z0JBS0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFHdEMsQ0FBQztRQUVMLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQyxDQUFDLENBQUE7QUFFTixDQUFDO0FBSUQsK0JBQStCLEdBQVc7SUFDdEMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07UUFHL0IsSUFBTSxHQUFHLEdBQUcsZ0JBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUU1QixJQUFNLEtBQUssR0FBRyxFQUFFLENBQUE7UUFHaEIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFFbEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFRLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzlDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7WUFDdEIsQ0FBQztRQUVMLENBQUM7UUFHRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbkIsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNyQixNQUFNLENBQUMsYUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRTtvQkFDMUMsYUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2hELENBQUMsQ0FBQyxDQUFDO1lBR0gsb0JBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUMsR0FBRyxFQUFFLFVBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNO2dCQUN4RCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDZixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDakIsQ0FBQztZQUVMLENBQUMsQ0FBQyxDQUFBO1FBRU4sQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUE7UUFDaEMsQ0FBQztJQUVMLENBQUMsQ0FBQyxDQUFBO0FBRU4sQ0FBQztBQUVELGtCQUFrQixHQUFXO0lBQ3pCLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1FBRS9CLDJCQUEyQixHQUFXO1lBRWxDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxPQUFPO2dCQUc5QixFQUFFLENBQUMsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFFZixxQkFBcUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBRTVCLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUUxQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDZixDQUFDLENBQUMsQ0FBQTtnQkFFTixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDakIsQ0FBQztZQUlMLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7Z0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2YsQ0FBQyxDQUFDLENBQUE7UUFFTixDQUFDO1FBQ0QsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDMUIsQ0FBQyxDQUFDLENBQUE7QUFHTixDQUFDO0FBRUQseUJBQWdDLEdBQVcsRUFBRSxPQUFtRDtJQUU1RixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUcvQixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFUCxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQztnQkFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7WUFFaEUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFFN0IsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBRUosRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQVE1RCxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsT0FBTztnQkFHOUIsRUFBRSxDQUFDLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBRWYsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7d0JBRWpCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDOzRCQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7d0JBQzVELE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFFZCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNULEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDOzRCQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7d0JBQ2xELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDZixDQUFDLENBQUMsQ0FBQTtnQkFFTixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDO3dCQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUE7b0JBQzNELE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO2dCQUNyQyxDQUFDO1lBR0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRztnQkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDZixDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUM7SUFFTCxDQUFDLENBQUMsQ0FBQTtBQUVOLENBQUM7QUFsREQsMENBa0RDO0FBR0Q7SUFLSSxrQ0FBWSxPQUErRTtRQUV2RixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFFWCxNQUFNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1FBRWxDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUVKLElBQUksQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQTtZQUd0QixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7Z0JBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFBO1lBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtZQUVoQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7Z0JBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFBO1lBRTFELElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFBO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFBO1FBR3ZELENBQUM7SUFHTCxDQUFDO0lBR0Qsc0NBQUcsR0FBSDtRQUNJLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNqQixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUUvQixlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO2dCQUNuRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO29CQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7Z0JBQzlDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNkLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQUc7Z0JBQ1IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDZixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVELDRDQUFTLEdBQVQsVUFBVSxRQUFpQjtRQUN2QixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFBQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQTtRQUV0QyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUE7UUFHakIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ1YsV0FBVyxDQUFDO1lBQ1IsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ2QsQ0FBQyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUVyQixDQUFDO0lBRUwsK0JBQUM7QUFBRCxDQTFEQSxBQTBEQyxJQUFBO0FBMURZLDREQUF3QiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vXG5cbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiXG5pbXBvcnQgeyByZWFkZGlyU3luYywgc3RhdFN5bmMgfSBmcm9tIFwiZnNcIlxuXG5mdW5jdGlvbiBnZXRQZXJjZW50U3BhY2UoZGlyOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgIGV4ZWMoXCJkZiAtaCBcIiArIGRpciArIFwiIHwgZ3JlcCAnLydcIiwgKGVyciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlb3V0ID0gW11cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZG91dC5zcGxpdChcIiBcIikubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZG91dC5zcGxpdChcIiBcIilbaV0pIHJlb3V0LnB1c2goc3Rkb3V0LnNwbGl0KFwiIFwiKVtpXS5yZXBsYWNlKCdcXG4nLCAnJykpXG4gICAgICAgICAgICAgICAgfVxuXG5cblxuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZW91dFs0XS5yZXBsYWNlKCclJywgJycpKVxuXG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KVxuXG4gICAgfSlcblxufVxuXG5cblxuZnVuY3Rpb24gcmVtb3ZlTGFzdEZpbGVGcm9tRGlyKGRpcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuXG4gICAgICAgIGNvbnN0IGZpcyA9IHJlYWRkaXJTeW5jKGRpcilcblxuICAgICAgICBjb25zdCBmaWxlcyA9IFtdXG5cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpcy5sZW5ndGg7IGkrKykge1xuXG4gICAgICAgICAgICBpZiAoIXN0YXRTeW5jKGRpciArIFwiL1wiICsgZmlzW2ldKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgZmlsZXMucHVzaChmaXNbaV0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuXG5cbiAgICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDEpIHtcblxuICAgICAgICAgICAgZmlsZXMuc29ydChmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0U3luYyhkaXIgKyBcIi9cIiArIGEpLm10aW1lLmdldFRpbWUoKSAtXG4gICAgICAgICAgICAgICAgICAgIHN0YXRTeW5jKGRpciArIFwiL1wiICsgYikubXRpbWUuZ2V0VGltZSgpO1xuICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICAgICAgZXhlYyhcInJtICdcIiArIGRpciArIFwiL1wiICsgZmlsZXNbMF0rXCInXCIsIChlcnIsIHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChcIm5vdGhpbmcgdG8gcmVtb3ZlIVwiKVxuICAgICAgICB9XG5cbiAgICB9KVxuXG59XG5cbmZ1bmN0aW9uIHJlbWZpbGVzKGRpcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVyZW1maWxlcyhkaXI6IHN0cmluZykge1xuXG4gICAgICAgICAgICBnZXRQZXJjZW50U3BhY2UoZGlyKS50aGVuKChwZXJjZW50KSA9PiB7XG5cblxuICAgICAgICAgICAgICAgIGlmIChwZXJjZW50ID4gMTApIHtcblxuICAgICAgICAgICAgICAgICAgICByZW1vdmVMYXN0RmlsZUZyb21EaXIoZGlyKS50aGVuKCgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlcmVtZmlsZXMoZGlyKVxuXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpXG4gICAgICAgICAgICAgICAgfVxuXG5cblxuICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH1cbiAgICAgICAgcmVjdXJzaXZlcmVtZmlsZXMoZGlyKVxuICAgIH0pXG5cblxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tTcGFjZUluRGlyKGRpcjogc3RyaW5nLCBvcHRpb25zPzogeyBleHRlbnNpb24/OiBzdHJpbmcsIHZlcmJvc2U/OiBib29sZWFuIH0pIHtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cblxuICAgICAgICBpZiAoIWRpcikge1xuXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnZlcmJvc2UpIGNvbnNvbGUuZXJyb3IoXCJObyBkaXIgcHJvdmlkZWRcIilcblxuICAgICAgICAgICAgcmVqZWN0KFwiTm8gZGlyIHByb3ZpZGVkXCIpXG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy52ZXJib3NlKSBjb25zb2xlLmxvZyhcImNoZWNraW5nIGRpc2tcIilcblxuXG5cblxuICAgICAgICAgICAgLy8gcmVtb3ZlIGZpbGVzIChiYXNlZCBvbiBleHRlbnNpb24gaWYgZXh0ZW5zaW9uIGlzIHByb3ZpZGVkKSwgYnkgbW9kaWZpZWQgdGltZVxuXG5cbiAgICAgICAgICAgIGdldFBlcmNlbnRTcGFjZShkaXIpLnRoZW4oKHBlcmNlbnQpID0+IHtcblxuXG4gICAgICAgICAgICAgICAgaWYgKHBlcmNlbnQgPiAxMCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHJlbWZpbGVzKGRpcikudGhlbigoYSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnZlcmJvc2UpIGNvbnNvbGUubG9nKFwic3BhY2UgY2xlYW5lZFwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudmVyYm9zZSkgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy52ZXJib3NlKSBjb25zb2xlLmxvZyhcImRpc2sgY2hlY2tlZFwiKVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKFwiZGlzayBvaywgbm90aGluZyB0byBkb1wiKVxuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfVxuXG4gICAgfSlcblxufVxuXG5cbmV4cG9ydCBjbGFzcyByZWN1cnNpdmVjaGVja1NwYWNlSW5EaXIge1xuICAgIGRpcjogc3RyaW5nXG4gICAgZXh0ZW5zaW9uPzogc3RyaW5nXG4gICAgaW50ZXJ2YWw6IG51bWJlclxuICAgIHZlcmJvc2U6IGJvb2xlYW5cbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zOiB7IGRpcjogc3RyaW5nLCBleHRlbnNpb24/OiBzdHJpbmcsIGludGVydmFsPzogbnVtYmVyLCB2ZXJib3NlPzogdHJ1ZSB9KSB7XG5cbiAgICAgICAgaWYgKCFvcHRpb25zKSB7XG5cbiAgICAgICAgICAgIHRocm93IEVycm9yKFwiTm8gZGlyIHByb3ZpZGVkXCIpXG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgdGhpcy5kaXIgPSBvcHRpb25zLmRpclxuXG5cbiAgICAgICAgICAgIGlmICghb3B0aW9ucy5pbnRlcnZhbCkgb3B0aW9ucy5pbnRlcnZhbCA9IDUgKiA2MFxuICAgICAgICAgICAgdGhpcy5pbnRlcnZhbCA9IG9wdGlvbnMuaW50ZXJ2YWxcblxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmV4dGVuc2lvbikgdGhpcy5leHRlbnNpb24gPSBvcHRpb25zLmV4dGVuc2lvblxuXG4gICAgICAgICAgICB0aGlzLnZlcmJvc2UgPSBmYWxzZVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudmVyYm9zZSkgdGhpcy52ZXJib3NlID0gb3B0aW9ucy52ZXJib3NlXG5cblxuICAgICAgICB9XG5cblxuICAgIH1cblxuXG4gICAgcnVuKCkge1xuICAgICAgICBjb25zdCB0aGF0ID0gdGhpc1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICBjaGVja1NwYWNlSW5EaXIodGhhdC5kaXIsIHsgZXh0ZW5zaW9uOiB0aGF0LmV4dGVuc2lvbiwgdmVyYm9zZTogdGhhdC52ZXJib3NlIH0pLnRoZW4oKGEpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhhdC52ZXJib3NlKSBjb25zb2xlLmxvZyhcImRpc2sgY2hlY2sgb2tcIilcbiAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICB9KS50aGVuKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhhdC52ZXJib3NlKSBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICBkYWVtb25pemUoaW50ZXJ2YWw/OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKGludGVydmFsKSB0aGlzLmludGVydmFsID0gaW50ZXJ2YWxcblxuICAgICAgICBjb25zdCB0aGF0ID0gdGhpc1xuXG5cbiAgICAgICAgdGhhdC5ydW4oKVxuICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICB0aGF0LnJ1bigpXG4gICAgICAgIH0sIHRoaXMuaW50ZXJ2YWwpXG5cbiAgICB9XG5cbn0iXX0=
