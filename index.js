"use strict";
var Promise = require("bluebird");
var child_process_1 = require("child_process");
var fs_1 = require("fs");
function getPercentSpace(dir) {
    return new Promise(function (resolve, reject) {
        child_process_1.exec("df -h " + dir + " | grep '/'", function (err, stdout, stderr) {
            if (err) {
                reject(err);
            }
            else {
                var reout = [];
                for (var i = 0; i < stdout.split(" ").length; i++) {
                    if (stdout.split(" ")[i])
                        reout.push(stdout.split(" ")[i].replace('\n', ''));
                }
                resolve(reout[4].replace('%', ''));
            }
        });
    });
}
function removeLastFileFromDir(dir) {
    return new Promise(function (resolve, reject) {
        var files = fs_1.readdirSync(dir);
        if (files.length > 1) {
            files.sort(function (a, b) {
                return fs_1.statSync(dir + "/" + a).mtime.getTime() -
                    fs_1.statSync(dir + "/" + b).mtime.getTime();
            });
            child_process_1.exec("rm " + files[0], function (err, stdout, stderr) {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(true);
                }
            });
        }
        else {
            reject("nothing to remove!");
        }
    });
}
function remfiles(dir) {
    return new Promise(function (resolve, reject) {
        function recursiveremfiles(dir) {
            getPercentSpace(dir).then(function (percent) {
                if (percent > 90) {
                    removeLastFileFromDir(dir).then(function () {
                        recursiveremfiles(dir);
                    }).catch(function (err) {
                        reject(err);
                    });
                }
                else {
                    resolve(true);
                }
            }).catch(function (err) {
                reject(err);
            });
        }
    });
}
function checkSpaceInDir(dir, options) {
    return new Promise(function (resolve, reject) {
        if (!dir) {
            if (options && options.verbose)
                console.error("No dir provided");
            reject("No dir provided");
        }
        else {
            if (options && options.verbose)
                console.log("checking disk");
            getPercentSpace(dir).then(function (percent) {
                if (percent > 90) {
                    remfiles(dir).then(function (a) {
                        if (options && options.verbose)
                            console.log("space cleaned");
                        resolve(a);
                    }).catch(function (err) {
                        if (options && options.verbose)
                            console.error(err);
                        reject(err);
                    });
                }
                else {
                    if (options && options.verbose)
                        console.log("disk checked");
                    resolve("disk ok, nothing to do");
                }
            }).catch(function (err) {
                reject(err);
            });
        }
    });
}
exports.checkSpaceInDir = checkSpaceInDir;
var recursivecheckSpaceInDir = (function () {
    function recursivecheckSpaceInDir(options) {
        if (!options) {
            throw Error("No dir provided");
        }
        else {
            this.dir = options.dir;
            if (!options.interval)
                options.interval = 5 * 60;
            this.interval = options.interval;
            if (!options.extension)
                this.extension = options.extension;
            this.verbose = false;
            if (options.verbose)
                this.verbose = options.verbose;
        }
    }
    recursivecheckSpaceInDir.prototype.run = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            checkSpaceInDir(that.dir, { extension: that.extension, verbose: that.verbose }).then(function (a) {
                if (that.verbose)
                    console.log("disk check ok");
                resolve(a);
            }).then(function (err) {
                if (that.verbose)
                    console.error(err);
                reject(err);
            });
        });
    };
    recursivecheckSpaceInDir.prototype.daemonize = function (interval) {
        if (interval)
            this.interval = interval;
        var that = this;
        that.run();
        setInterval(function () {
            that.run();
        }, this.interval);
    };
    return recursivecheckSpaceInDir;
}());
exports.recursivecheckSpaceInDir = recursivecheckSpaceInDir;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxrQ0FBbUM7QUFDbkMsK0NBQW9DO0FBQ3BDLHlCQUEwQztBQUUxQyx5QkFBeUIsR0FBVztJQUNoQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUUvQixvQkFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsYUFBYSxFQUFFLFVBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNO1lBQ3JELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2YsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVKLElBQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQTtnQkFDaEIsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO29CQUNoRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7Z0JBQ2hGLENBQUM7Z0JBS0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFHdEMsQ0FBQztRQUVMLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQyxDQUFDLENBQUE7QUFFTixDQUFDO0FBSUQsK0JBQStCLEdBQVc7SUFDdEMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07UUFHL0IsSUFBTSxLQUFLLEdBQUcsZ0JBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUvQixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbkIsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUNyQixNQUFNLENBQUMsYUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRTtvQkFDMUMsYUFBUSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2hELENBQUMsQ0FBQyxDQUFDO1lBR0gsb0JBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNO2dCQUN2QyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDZixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDakIsQ0FBQztZQUVMLENBQUMsQ0FBQyxDQUFBO1FBRU4sQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUE7UUFDaEMsQ0FBQztJQUVMLENBQUMsQ0FBQyxDQUFBO0FBRU4sQ0FBQztBQUVELGtCQUFrQixHQUFXO0lBQ3pCLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1FBRS9CLDJCQUEyQixHQUFXO1lBRWxDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxPQUFPO2dCQUc5QixFQUFFLENBQUMsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFFZixxQkFBcUIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBRTVCLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUUxQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNULE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDZixDQUFDLENBQUMsQ0FBQTtnQkFFTixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtnQkFDakIsQ0FBQztZQUlMLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUc7Z0JBQ1QsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2YsQ0FBQyxDQUFDLENBQUE7UUFFTixDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUE7QUFHTixDQUFDO0FBRUQseUJBQWdDLEdBQVcsRUFBRSxPQUFtRDtJQUU1RixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtRQUcvQixFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFUCxFQUFFLENBQUMsQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQztnQkFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUE7WUFFaEUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFFN0IsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBRUosRUFBRSxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQVE1RCxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsT0FBTztnQkFHOUIsRUFBRSxDQUFDLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBS2YsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7d0JBRWpCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDOzRCQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7d0JBQzVELE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFFZCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO3dCQUNULEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDOzRCQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7d0JBR2xELE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDZixDQUFDLENBQUMsQ0FBQTtnQkFJTixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDO3dCQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUE7b0JBQzNELE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO2dCQUNyQyxDQUFDO1lBR0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUMsR0FBRztnQkFDVCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDZixDQUFDLENBQUMsQ0FBQTtRQUtOLENBQUM7SUFFTCxDQUFDLENBQUMsQ0FBQTtBQUVOLENBQUM7QUE1REQsMENBNERDO0FBR0Q7SUFLSSxrQ0FBWSxPQUErRTtRQUV2RixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFFWCxNQUFNLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1FBRWxDLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUVKLElBQUksQ0FBQyxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQTtZQUd0QixFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7Z0JBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFBO1lBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtZQUVoQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7Z0JBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFBO1lBRTFELElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFBO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFBO1FBR3ZELENBQUM7SUFHTCxDQUFDO0lBR0Qsc0NBQUcsR0FBSDtRQUNJLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQTtRQUNqQixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUUvQixlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDO2dCQUNuRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO29CQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUE7Z0JBQzlDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNkLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEdBQUc7Z0JBQ1IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDZixDQUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUVELDRDQUFTLEdBQVQsVUFBVSxRQUFpQjtRQUN2QixFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFBQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQTtRQUV0QyxJQUFNLElBQUksR0FBRyxJQUFJLENBQUE7UUFHakIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ1YsV0FBVyxDQUFDO1lBQ1IsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFBO1FBQ2QsQ0FBQyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUVyQixDQUFDO0lBRUwsK0JBQUM7QUFBRCxDQTFEQSxBQTBEQyxJQUFBO0FBMURZLDREQUF3QiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vXG5cbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCJcbmltcG9ydCB7IGV4ZWMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiXG5pbXBvcnQgeyByZWFkZGlyU3luYywgc3RhdFN5bmMgfSBmcm9tIFwiZnNcIlxuXG5mdW5jdGlvbiBnZXRQZXJjZW50U3BhY2UoZGlyOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgIGV4ZWMoXCJkZiAtaCBcIiArIGRpciArIFwiIHwgZ3JlcCAnLydcIiwgKGVyciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlb3V0ID0gW11cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ZG91dC5zcGxpdChcIiBcIikubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ZG91dC5zcGxpdChcIiBcIilbaV0pIHJlb3V0LnB1c2goc3Rkb3V0LnNwbGl0KFwiIFwiKVtpXS5yZXBsYWNlKCdcXG4nLCAnJykpXG4gICAgICAgICAgICAgICAgfVxuXG5cblxuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZW91dFs0XS5yZXBsYWNlKCclJywgJycpKVxuXG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KVxuXG4gICAgfSlcblxufVxuXG5cblxuZnVuY3Rpb24gcmVtb3ZlTGFzdEZpbGVGcm9tRGlyKGRpcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuXG4gICAgICAgIGNvbnN0IGZpbGVzID0gcmVhZGRpclN5bmMoZGlyKTtcblxuICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID4gMSkge1xuXG4gICAgICAgICAgICBmaWxlcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRTeW5jKGRpciArIFwiL1wiICsgYSkubXRpbWUuZ2V0VGltZSgpIC1cbiAgICAgICAgICAgICAgICAgICAgc3RhdFN5bmMoZGlyICsgXCIvXCIgKyBiKS5tdGltZS5nZXRUaW1lKCk7XG4gICAgICAgICAgICB9KTtcblxuXG4gICAgICAgICAgICBleGVjKFwicm0gXCIgKyBmaWxlc1swXSwgKGVyciwgc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KFwibm90aGluZyB0byByZW1vdmUhXCIpXG4gICAgICAgIH1cblxuICAgIH0pXG5cbn1cblxuZnVuY3Rpb24gcmVtZmlsZXMoZGlyOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZXJlbWZpbGVzKGRpcjogc3RyaW5nKSB7XG5cbiAgICAgICAgICAgIGdldFBlcmNlbnRTcGFjZShkaXIpLnRoZW4oKHBlcmNlbnQpID0+IHtcblxuXG4gICAgICAgICAgICAgICAgaWYgKHBlcmNlbnQgPiA5MCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUxhc3RGaWxlRnJvbURpcihkaXIpLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVyZW1maWxlcyhkaXIpXG5cbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSlcbiAgICAgICAgICAgICAgICB9XG5cblxuXG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgfVxuICAgIH0pXG5cblxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hlY2tTcGFjZUluRGlyKGRpcjogc3RyaW5nLCBvcHRpb25zPzogeyBleHRlbnNpb24/OiBzdHJpbmcsIHZlcmJvc2U/OiBib29sZWFuIH0pIHtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cblxuICAgICAgICBpZiAoIWRpcikge1xuXG4gICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnZlcmJvc2UpIGNvbnNvbGUuZXJyb3IoXCJObyBkaXIgcHJvdmlkZWRcIilcblxuICAgICAgICAgICAgcmVqZWN0KFwiTm8gZGlyIHByb3ZpZGVkXCIpXG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy52ZXJib3NlKSBjb25zb2xlLmxvZyhcImNoZWNraW5nIGRpc2tcIilcblxuXG5cblxuICAgICAgICAgICAgLy8gcmVtb3ZlIGZpbGVzIChiYXNlZCBvbiBleHRlbnNpb24gaWYgZXh0ZW5zaW9uIGlzIHByb3ZpZGVkKSwgYnkgbW9kaWZpZWQgdGltZVxuXG5cbiAgICAgICAgICAgIGdldFBlcmNlbnRTcGFjZShkaXIpLnRoZW4oKHBlcmNlbnQpID0+IHtcblxuXG4gICAgICAgICAgICAgICAgaWYgKHBlcmNlbnQgPiA5MCkge1xuXG5cblxuXG4gICAgICAgICAgICAgICAgICAgIHJlbWZpbGVzKGRpcikudGhlbigoYSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnZlcmJvc2UpIGNvbnNvbGUubG9nKFwic3BhY2UgY2xlYW5lZFwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMudmVyYm9zZSkgY29uc29sZS5lcnJvcihlcnIpXG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSlcblxuXG5cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnZlcmJvc2UpIGNvbnNvbGUubG9nKFwiZGlzayBjaGVja2VkXCIpXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoXCJkaXNrIG9rLCBub3RoaW5nIHRvIGRvXCIpXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcblxuXG5cblxuICAgICAgICB9XG5cbiAgICB9KVxuXG59XG5cblxuZXhwb3J0IGNsYXNzIHJlY3Vyc2l2ZWNoZWNrU3BhY2VJbkRpciB7XG4gICAgZGlyOiBzdHJpbmdcbiAgICBleHRlbnNpb24/OiBzdHJpbmdcbiAgICBpbnRlcnZhbDogbnVtYmVyXG4gICAgdmVyYm9zZTogYm9vbGVhblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IHsgZGlyOiBzdHJpbmcsIGV4dGVuc2lvbj86IHN0cmluZywgaW50ZXJ2YWw/OiBudW1iZXIsIHZlcmJvc2U/OiB0cnVlIH0pIHtcblxuICAgICAgICBpZiAoIW9wdGlvbnMpIHtcblxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJObyBkaXIgcHJvdmlkZWRcIilcblxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICB0aGlzLmRpciA9IG9wdGlvbnMuZGlyXG5cblxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmludGVydmFsKSBvcHRpb25zLmludGVydmFsID0gNSAqIDYwXG4gICAgICAgICAgICB0aGlzLmludGVydmFsID0gb3B0aW9ucy5pbnRlcnZhbFxuXG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMuZXh0ZW5zaW9uKSB0aGlzLmV4dGVuc2lvbiA9IG9wdGlvbnMuZXh0ZW5zaW9uXG5cbiAgICAgICAgICAgIHRoaXMudmVyYm9zZSA9IGZhbHNlXG4gICAgICAgICAgICBpZiAob3B0aW9ucy52ZXJib3NlKSB0aGlzLnZlcmJvc2UgPSBvcHRpb25zLnZlcmJvc2VcblxuXG4gICAgICAgIH1cblxuXG4gICAgfVxuXG5cbiAgICBydW4oKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIGNoZWNrU3BhY2VJbkRpcih0aGF0LmRpciwgeyBleHRlbnNpb246IHRoYXQuZXh0ZW5zaW9uLCB2ZXJib3NlOiB0aGF0LnZlcmJvc2UgfSkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGF0LnZlcmJvc2UpIGNvbnNvbGUubG9nKFwiZGlzayBjaGVjayBva1wiKVxuICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgIH0pLnRoZW4oKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGF0LnZlcmJvc2UpIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cblxuICAgIGRhZW1vbml6ZShpbnRlcnZhbD86IG51bWJlcikge1xuICAgICAgICBpZiAoaW50ZXJ2YWwpIHRoaXMuaW50ZXJ2YWwgPSBpbnRlcnZhbFxuXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG5cblxuICAgICAgICB0aGF0LnJ1bigpXG4gICAgICAgIHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgIHRoYXQucnVuKClcbiAgICAgICAgfSwgdGhpcy5pbnRlcnZhbClcblxuICAgIH1cblxufSJdfQ==
